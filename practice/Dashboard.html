<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EDUKUL — Student Report</title>

  <!-- Tailwind CDN (v2 utility-compatible) -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

  <!-- html2canvas + jspdf (for PDF) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* Base page */
    :root{
      --bg-1: linear-gradient(180deg,#f3f6fb,#ffffff);
      --muted: #6b7280;
      --card-bg: #ffffff;
    }
    html,body{height:100%}
    body{
      background: var(--bg-1);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding: 18px;
      color: #0f172a;
    }

    /* Card */
    .card{
      background: var(--card-bg);
      border-radius: 14px;
      padding: 18px;
      box-shadow: 0 8px 28px rgba(14,30,37,0.06);
    }

    .muted{ color: var(--muted) }
    .small{ font-size:13px; color:var(--muted) }
    .stat{
      border-radius:12px;
      padding:12px;
      background:#f8fafc;
      text-align:center;
    }

    /* subtle responsive adjustments */
    @media (max-width: 640px){
      body{ padding: 12px; }
      .card{ padding: 12px; border-radius:12px; }
    }

    /* loader overlay */
    #loaderOverlay{
      backdrop-filter: blur(3px);
    }

    /* improved recent list */
    .recent-item{ padding: 10px; border-bottom: 1px dashed #eef2f7; display:flex; gap:8px; align-items:center; }
    .badge{ font-size:12px; padding:6px 8px; border-radius:8px; background:#eef2ff; color:#1e3a8a; }

    /* image rounded */
    #studentPhoto { width:84px; height:84px; object-fit:cover; border-radius:10px; border:1px solid #e6eefb;}
  </style>
</head>
<body>
  <div class="max-w-5xl mx-auto">

    <!-- SEARCH AREA -->
    <div id="searchArea" class="card mb-5 flex flex-col sm:flex-row sm:items-center gap-4">
      <div class="flex items-center gap-3">
        <img src="https://cdn.razorpay.com/logos/NMTURjAnNH1AQ5_large.png" alt="EDUKUL" style="height:56px">
        <div>
          <h1 class="text-xl font-semibold">EDUKUL — Student Report</h1>
          <div class="small">Enter Roll No and press Search → then generate PDF</div>
        </div>
      </div>

      <div class="ml-auto flex items-center gap-2">
        <input id="rollInput" class="border rounded px-3 py-2 w-48 sm:w-64 focus:outline-none" placeholder="Enter Roll No (e.g. 251179)" aria-label="Roll number">
        <button id="searchBtn" onclick="onSearch()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded flex items-center gap-2">
          <svg id="searchIcon" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-4.35-4.35m0 0A7.5 7.5 0 1116.65 16.65z" />
          </svg>
          <span id="searchBtnText">Search</span>
        </button>
      </div>
    </div>

    <!-- REPORT -->
    <div id="reportContainer" class="card" style="display:none">
      <!-- header -->
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
        <div class="flex items-center gap-4">
          <img id="studentPhoto" src="https://via.placeholder.com/100" alt="photo">
          <div>
            <div class="text-lg font-bold" id="studentName">Student Name</div>
            <div class="small" id="studentBatchClass">Batch / Class</div>
            <div class="small" id="studentRollView">Roll: -</div>
          </div>
        </div>

        <div class="flex items-center gap-4">
          <div class="text-right small">
            <div>Last updated: <span id="lastUpdated">-</span></div>
            <div class="mt-2 small">Batch progress snapshot</div>
          </div>
          <div class="stat text-center min-w-24">
            <div class="small">Total Quizzes</div>
            <div id="totalQuizzes" class="font-bold text-xl">0</div>
          </div>
        </div>
      </div>

      <!-- summary stats -->
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3 mb-4">
        <div class="stat">
          <div class="small">Overall Avg %</div>
          <div id="overallAvg" class="font-bold text-lg">0%</div>
        </div>

        <div class="stat">
          <div class="small">Best Rank</div>
          <div id="bestRank" class="font-bold text-lg">-</div>
        </div>

        <div class="stat">
          <div class="small">Weak Subject</div>
          <div id="weakSub" class="font-bold text-lg">-</div>
        </div>
      </div>

      <!-- subject cards -->
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3 mb-4">
        <!-- Physics -->
        <div class="card">
          <div class="flex justify-between items-start mb-3">
            <div>
              <div class="small font-semibold">Physics</div>
              <div id="physicsCount" class="text-lg font-bold">0 attempts</div>
              <div class="small">Avg: <span id="physicsAvg">0</span>%</div>
            </div>
            <div class="text-right">
              <div class="small">Correct</div>
              <div id="physicsCorrect" class="font-bold">0</div>
              <div class="small mt-2">Wrong</div>
              <div id="physicsWrong" class="text-sm">0</div>
            </div>
          </div>
          <div class="bg-white p-2 rounded-md">
            <canvas id="physicsChart" height="120"></canvas>
          </div>
        </div>

        <!-- Chemistry -->
        <div class="card">
          <div class="flex justify-between items-start mb-3">
            <div>
              <div class="small font-semibold">Chemistry</div>
              <div id="chemistryCount" class="text-lg font-bold">0 attempts</div>
              <div class="small">Avg: <span id="chemistryAvg">0</span>%</div>
            </div>
            <div class="text-right">
              <div class="small">Correct</div>
              <div id="chemistryCorrect" class="font-bold">0</div>
              <div class="small mt-2">Wrong</div>
              <div id="chemistryWrong" class="text-sm">0</div>
            </div>
          </div>
          <div class="bg-white p-2 rounded-md">
            <canvas id="chemistryChart" height="120"></canvas>
          </div>
        </div>

        <!-- Maths -->
        <div class="card">
          <div class="flex justify-between items-start mb-3">
            <div>
              <div class="small font-semibold">Maths</div>
              <div id="mathsCount" class="text-lg font-bold">0 attempts</div>
              <div class="small">Avg: <span id="mathsAvg">0</span>%</div>
            </div>
            <div class="text-right">
              <div class="small">Correct</div>
              <div id="mathsCorrect" class="font-bold">0</div>
              <div class="small mt-2">Wrong</div>
              <div id="mathsWrong" class="text-sm">0</div>
            </div>
          </div>
          <div class="bg-white p-2 rounded-md">
            <canvas id="mathsChart" height="120"></canvas>
          </div>
        </div>
      </div>

      <!-- overall progress -->
      <div class="mb-4 card">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-semibold">Progress (Quiz % over time)</h3>
          <div class="small muted">Trend of last quizzes</div>
        </div>
        <div class="p-2 bg-white rounded-md">
          <canvas id="overallChart" height="160"></canvas>
        </div>
      </div>

      <!-- recent tests -->
      <div class="mb-4 card">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-semibold">Recent Quizzes (latest 10)</h3>
          <div class="small muted">Most recent first</div>
        </div>
        <div id="recentList" class="small">
          <!-- populated dynamically -->
        </div>
      </div>

      <!-- actions -->
      <div class="flex justify-end gap-3">
        <button id="saveDriveBtn" class="bg-indigo-600 text-white px-4 py-2 rounded" onclick="savePdfToDrive()">Save PDF to Drive</button>
        <button id="downloadBtn" class="bg-green-600 text-white px-4 py-2 rounded" onclick="downloadPdf()">Download PDF</button>
      </div>
    </div>

    <!-- Loader Overlay -->
    <div id="loaderOverlay" class="fixed inset-0 z-50 hidden items-center justify-center">
      <div class="flex flex-col items-center gap-3">
        <div class="animate-spin rounded-full h-16 w-16 border-4 border-white border-t-transparent"></div>
        <div class="text-white font-medium bg-black bg-opacity-50 px-4 py-2 rounded">Fetching report…</div>
      </div>
    </div>

  </div>

  <script>
    // ========== CONFIG ==========
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzT6C6xqCefkHQTzcO-E210f1ifFcmf0YwF9uHh5DpDKsnNyZhFRdMLnc2wLj_Uh3Id/exec';
    const charts = {};

    // ========== UI Helpers ==========
    function showLoader(){
      document.getElementById('loaderOverlay').classList.remove('hidden');
      // Dim search area so it looks inactive on mobile too
      document.getElementById('searchArea').style.opacity = "0.6";
    }
    function hideLoader(){
      document.getElementById('loaderOverlay').classList.add('hidden');
      document.getElementById('searchArea').style.opacity = "1";
    }

    function serverFetch(roll){
      // returns a promise that resolves to JSON (throws if non-OK)
      return fetch(SCRIPT_URL + '?roll=' + encodeURIComponent(roll)).then(r=>{
        if(!r.ok) throw new Error('Network response not ok: '+r.status);
        return r.json();
      });
    }

    // ========== MAIN SEARCH ==========
    async function onSearch(){
      const rollInput = document.getElementById('rollInput');
      const roll = rollInput.value.trim();
      if(!roll) return alert('Please enter Roll No.');

      const btn = document.getElementById('searchBtn');
      const btnText = document.getElementById('searchBtnText');
      const searchIcon = document.getElementById('searchIcon');

      // disable UI
      btn.disabled = true;
      btn.classList.add('opacity-70', 'cursor-not-allowed');
      btnText.innerText = 'Searching...';
      searchIcon.style.display = 'none';
      showLoader();

      try{
        const data = await serverFetch(roll);
        if(data.error){
          alert('Error: ' + data.error);
          return;
        }
        document.getElementById('reportContainer').style.display = 'block';
        populateReport(data);
      } catch(err){
        console.error('Fetch failed', err);
        alert('Failed to fetch report: ' + (err.message || err));
      } finally {
        // re-enable UI
        btn.disabled = false;
        btn.classList.remove('opacity-70', 'cursor-not-allowed');
        btnText.innerText = 'Search';
        searchIcon.style.display = '';
        hideLoader();
      }
    }

    // ========== POPULATE UI ==========
    function populateReport(data){
      const st = data.student || {};
      document.getElementById('studentName').innerText = st.name || '-';
      document.getElementById('studentBatchClass').innerText = (st.batch||'-') + ' / ' + (st.clazz||'-');
      document.getElementById('studentRollView').innerText = 'Roll: ' + (st.roll || '-');
      document.getElementById('studentPhoto').src = st.photo || 'https://via.placeholder.com/100';

      const summary = data.overall || {};
      document.getElementById('lastUpdated').innerText = summary.lastTestDate || '-';
      document.getElementById('totalQuizzes').innerText = summary.totalQuizzes || 0;
      document.getElementById('overallAvg').innerText = (summary.avgPercent || 0) + '%';
      document.getElementById('bestRank').innerText = summary.bestRank || '-';
      document.getElementById('weakSub').innerText = data.weakSubject || '-';

      const ss = data.subjectSummary || {};
      fillSubject('Physics', ss['Physics']);
      fillSubject('Chemistry', ss['Chemistry']);
      fillSubject('Maths', ss['Maths']);

      // Overall chart
      renderLineChart('overallChart',
        (summary.trend || []).map(x => x.date),
        (summary.trend || []).map(x => x.percent),
        'Overall %',
        '#2563eb');

      // Recent tests
      const recent = data.recentTests || [];
      const recentList = document.getElementById('recentList');
      recentList.innerHTML = recent.slice(0, 10).map(r => {
        const dateStr = r.dateStr || r.date || '-';
        const pct = (r.percent !== undefined && r.percent !== null) ? (r.percent + '%') : '-';
        return `<div class="recent-item">
                  <div style="flex:1;">
                    <div class="font-medium">${escapeHtml(r.testName || 'Quiz')}</div>
                    <div class="small muted">${dateStr} — ${r.subject || '-'} — Quiz# ${r.quizNo || '-'}</div>
                  </div>
                  <div class="text-right">
                    <div class="badge">${pct}</div>
                    <div class="small muted">${r.batch || ''}</div>
                  </div>
                </div>`;
      }).join('');
    }

    function fillSubject(name, s){
      s = s || { totalQuiz:0, avgPercent:0, totalCorrect:0, totalWrong:0, trend:[] };
      const key = name.toLowerCase();
      document.getElementById(key+'Count').innerText = (s.totalQuiz || 0) + ' attempts';
      document.getElementById(key+'Avg').innerText = (s.avgPercent || 0);
      document.getElementById(key+'Correct').innerText = (s.totalCorrect || 0);
      document.getElementById(key+'Wrong').innerText = (s.totalWrong || 0);

      // render subject chart with better visuals
      const colors = { 'physics':'#0ea5e9','chemistry':'#16a34a','maths':'#ef4444' };
      renderLineChart(key+'Chart',
        (s.trend || []).map(t => t.date),
        (s.trend || []).map(t => t.percent),
        name + ' %',
        colors[key] || '#111827');
    }

    // ========== CHARTS ==========
    function renderLineChart(canvasId, labels, dataPoints, label, color){
      // default safe arrays
      labels = labels || [];
      dataPoints = dataPoints || [];

      const el = document.getElementById(canvasId);
      if(!el) return;
      const ctx = el.getContext('2d');
      if(charts[canvasId]) { charts[canvasId].destroy(); delete charts[canvasId]; }

      // Chart.js options tuned for visibility
      charts[canvasId] = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: label,
            data: dataPoints,
            borderColor: color,
            backgroundColor: 'rgba(0,0,0,0)',
            tension: 0.25,
            pointRadius: 4,
            pointHoverRadius:6,
            fill:false,
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              grid: { color: '#eef2f7' },
              ticks: { stepSize: 10 }
            },
            x: {
              grid: { display: false },
              ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 8 }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: { enabled: true, mode: 'nearest', intersect: false }
          },
          elements: { line: { capBezierPoints: true } }
        }
      });
    }

    // ========== PDF ==========
    async function downloadPdf(){
      const search = document.getElementById('searchArea');
      const report = document.getElementById('reportContainer');

      if(report.style.display === 'none'){
        return alert('Generate the report first by searching the roll number.');
      }

      // Temporarily hide elements that shouldn't be in PDF
      const actions = document.querySelectorAll('#searchArea, #saveDriveBtn, #downloadBtn');
      actions.forEach(a => a.style.display = 'none');

      // small delay to allow layout changes and fonts
      await new Promise(r => setTimeout(r, 250));

      // use html2canvas to render
      try{
        const canvas = await html2canvas(report, { scale: 2, useCORS:true, logging:false });
        const img = canvas.toDataURL('image/png');

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p','pt','a4');
        const pdfW = pdf.internal.pageSize.getWidth();
        const pdfH = (canvas.height * pdfW) / canvas.width;

        // if pdfH > pageHeight, split into pages
        const pageHeight = pdf.internal.pageSize.getHeight();
        if(pdfH <= pageHeight){
          pdf.addImage(img, 'PNG', 0, 0, pdfW, pdfH);
        } else {
          // slice algorithm: draw in multiple pages by canvas slicing
          const ratio = canvas.width / pdfW;
          const sliceHeight = Math.floor(pageHeight * ratio);
          let offset = 0;
          while(offset < canvas.height){
            const sliceCanvas = document.createElement('canvas');
            sliceCanvas.width = canvas.width;
            sliceCanvas.height = Math.min(sliceHeight, canvas.height - offset);
            const ctx = sliceCanvas.getContext('2d');
            ctx.drawImage(canvas, 0, offset, canvas.width, sliceCanvas.height, 0, 0, canvas.width, sliceCanvas.height);
            const sliceImg = sliceCanvas.toDataURL('image/png');
            const slicePdfH = (sliceCanvas.height * pdfW) / canvas.width;
            pdf.addImage(sliceImg, 'PNG', 0, 0, pdfW, slicePdfH);
            offset += sliceHeight;
            if(offset < canvas.height) pdf.addPage();
          }
        }

        // filename uses roll
        const rollText = (document.getElementById('rollInput').value || 'report').replace(/\s+/g,'_');
        pdf.save(`EDUKUL_Report_${rollText}.pdf`);
      } catch(err){
        console.error('PDF generation failed', err);
        alert('PDF generation failed: ' + (err.message || err));
      } finally {
        // restore UI
        actions.forEach(a => a.style.display = '');
      }
    }

    function savePdfToDrive(){
      // Apps Script integration is only available if hosted via Apps Script HTML template.
      alert('Drive-save works only when this page is served from Apps Script environment (client-to-server Apps Script flow). Use "Download PDF" for offline saving.');
    }

    // small helper for escaping HTML in recent list
    function escapeHtml(s){
      if(!s && s !== 0) return '';
      return String(s).replace(/[&<>"']/g, function(m){
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m];
      });
    }

    // ===== sample fallback demo (optional) =====
    // You can remove this: it's only to show a placeholder when SCRIPT_URL is unreachable in dev.
    // Uncomment to test with sample data:
    /*
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('rollInput').value = '251179';
      // Optionally auto-run search for demo:
      // onSearch();
    });
    */

  </script>
</body>
</html>
